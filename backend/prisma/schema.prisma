// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ─────────────────────────────────────────────
//   USER
// ─────────────────────────────────────────────
//

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  displayName  String?
  createdAt    DateTime @default(now())
  isLoggedIn   Boolean  @default(false)

  telegramAccounts TelegramAccount[]
  discordBots      DiscordBot[]  // Each user can have their own bot
}

//
// ─────────────────────────────────────────────
//   TELEGRAM (без змін)
// ─────────────────────────────────────────────
//

model TelegramAccount {
  id          String   @id @default(cuid())
  userId      String
  telegramId  String   @unique

  phoneNumber String?
  username    String?
  firstName   String?
  lastName    String?

  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  session     TelegramSession?

  messageIndex TelegramMessageIndex[]
  userCache    TelegramUserCache[]
}

model TelegramSession {
  id            String   @id @default(cuid())
  accountId     String   @unique
  sessionString String
  createdAt     DateTime @default(now())

  account TelegramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model TelegramMessageIndex {
  id        String   @id @default(uuid())
  accountId String
  account   TelegramAccount @relation(fields: [accountId], references: [id], onDelete: Restrict)

  messageId String
  chatId    String
  date      DateTime?
  deleted   Boolean  @default(false)

  rawPeerType   String?
  rawPeerId     String?
  rawAccessHash String?

  @@unique([accountId, messageId])
}

model TelegramUserCache {
  id        String   @id @default(cuid())
  accountId String
  userId    String

  firstName String?
  lastName  String?
  username  String?
  photoId   String?
  updatedAt DateTime @default(now())

  account TelegramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
}

// DISCORD

model DiscordBot {
  id          String   @id @default(cuid())
  userId      String

  botToken    String   @unique
  botUserId   String   @unique   // ← БІЛЬШЕ НЕ NULL
  botUsername String?
  applicationId String? 
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  guilds      DiscordBotGuild[]

  @@index([userId])
}

// Servers where this bot is located
model DiscordBotGuild {
  id        String   @id @default(cuid())
  botId     String
  guildId   String
  name      String?
  icon      String?
  createdAt DateTime @default(now())

  bot       DiscordBot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, guildId])
  @@index([botId])
}
